<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Belden Horizon | Intelligent Infrastructure</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f111a;
            --panel-bg: #1a1d2d;
            --text-primary: #e0e6ed;
            --belden-orange: #ff6600;
            --alert-red: #ff3333;
            --safe-green: #33cc33;
            --esg-green: #00e676; /* Bright Green for ESG */
            --purple: #aa44ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-height: 100vh;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--belden-orange);
            padding-bottom: 15px;
        }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; font-size: 2rem; }
        h1 span { font-weight: 700; color: var(--belden-orange); }

        /* Panels */
        .panel {
            background-color: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8b9bb4;
            margin-bottom: 15px;
            border-bottom: 1px solid #2d3345;
            padding-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Grid Layout for Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Graph takes 2/3, ESG takes 1/3 */
            gap: 25px;
        }

        /* Topology */
        #topology-container { height: 400px; }
        #network { width: 100%; height: 100%; border: 1px solid #2d3345; border-radius: 4px; background: #131620; }

        /* Metric Cards */
        .stats-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: space-between;
        }
        .metric-card {
            background: #252a40;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 5px solid var(--belden-orange);
            flex-grow: 1;
        }
        .metric-val { font-size: 2.5rem; font-weight: 700; line-height: 1; margin: 10px 0; }
        .label { font-size: 0.8rem; color: #8b9bb4; letter-spacing: 1px; font-weight: 600; }
        .unit { font-size: 0.9rem; color: #666; }

        /* ESG / Sustainability Panel */
        .esg-panel {
            background: rgba(0, 230, 118, 0.05);
            border: 1px solid rgba(0, 230, 118, 0.2);
        }
        .esg-val { color: var(--esg-green); font-size: 2.2rem; font-weight: bold; margin: 5px 0; }
        .esg-sub { font-size: 0.85rem; color: #88c; }

        canvas { width: 100%; max-height: 250px; }

        /* Alerts */
        #alert-container {
            background: #23263a;
            border: 1px solid #333;
            color: #666;
            text-align: center;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .critical-active {
            background: rgba(255, 51, 51, 0.15) !important;
            border: 2px solid var(--alert-red) !important;
            color: #fff !important;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.2);
            animation: pulse-border 1.5s infinite;
        }
        .critical-active #alert-title { color: var(--alert-red); font-weight: bold; font-size: 1.5rem; }
        @keyframes pulse-border {
            0% { border-color: var(--alert-red); }
            50% { border-color: #ff6666; box-shadow: 0 0 25px rgba(255,51,51,0.4); }
            100% { border-color: var(--alert-red); }
        }
    </style>
</head>
<body>

<header>
    <h1>BELDEN <span>HORIZON</span></h1>
    <div id="connection-status" style="color: var(--safe-green); font-weight: bold;">● SYSTEM ONLINE</div>
</header>

<div class="panel" id="topology-container">
    <div class="panel-title">1. Industrial Topology Map (Neo4j)</div>
    <div id="network"></div>
</div>

<div class="analytics-grid">
    <div class="panel">
        <div class="panel-title">2. Operational Analytics</div>
        <div class="stats-row">
            <div class="metric-card" id="card-health">
                <div class="label">HEALTH</div>
                <div class="metric-val" id="health-val">--</div>
            </div>
            <div class="metric-card" style="border-left-color: var(--purple);">
                <div class="label">RUL (DAYS)</div>
                <div class="metric-val" id="rul-val">--</div>
            </div>
        </div>
        <div style="flex-grow: 1;"><canvas id="healthChart"></canvas></div>
    </div>

    <div class="panel esg-panel">
        <div class="panel-title" style="color: var(--esg-green); border-color: var(--esg-green);">3. Sustainability Engine</div>

        <div style="text-align: center; margin-top: 10px;">
            <div class="label">CO₂ AVOIDED (KG)</div>
            <div class="esg-val" id="esg-avoided">--</div>
            <div class="esg-sub">By extending asset life</div>
        </div>

        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <div style="text-align: center;">
            <div class="label">EMBEDDED CARBON FOOTPRINT</div>
            <div class="esg-val" style="color: #fff; font-size: 1.8rem;" id="esg-embedded">--</div>
            <div class="esg-sub">Manufacturing + Transport</div>
        </div>

        <div style="margin-top: auto; text-align: center; padding-top: 20px;">
            <span style="background: var(--esg-green); color: #000; padding: 5px 10px; border-radius: 4px; font-weight: bold;">RATING: A+</span>
        </div>
    </div>
</div>

<div class="panel" id="alert-container">
    <div id="alert-title">NO ACTIVE ALERTS</div>
    <div id="alert-details">Predictive maintenance system standing by.</div>
    <div id="alert-savings" style="color: var(--safe-green); font-weight: bold; margin-top: 10px; display: none;"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8081/api';
    const CABLE_ID = 1;
    let healthChartInstance = null;

    window.onload = function() {
        initTopology();
        initChart();
        updateDashboard();
        setInterval(updateDashboard, 2000);
    };

    // --- TOPOLOGY (Vis.js) ---
    async function initTopology() {
        try {
            const response = await fetch(`${API_BASE}/dashboard/graph`);
            const data = await response.json();
            const nodes = new vis.DataSet(data.nodes.map(n => ({
                id: String(n.id), label: n.label, group: n.group ? n.group[0] : 'default',
                color: (n.group && n.group.includes('Cable')) ? '#ff6600' : (n.group && n.group.includes('Switch')) ? '#4488ff' : '#555',
                shape: 'dot', font: { color: '#fff' }
            })));
            const edges = new vis.DataSet(data.edges.map(e => ({ from: String(e.from), to: String(e.to), color: '#666' })));
            new vis.Network(document.getElementById('network'), { nodes, edges }, { physics: { stabilization: true } });
        } catch (e) { console.error(e); }
    }

    // --- CHART ---
    function initChart() {
        const ctx = document.getElementById('healthChart').getContext('2d');
        healthChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Health', data: [], borderColor: '#33cc33', borderWidth: 2, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { min: 0, max: 100, grid: { color: '#333' } } } }
        });
    }

    // --- UPDATE ---
    async function updateDashboard() {
        try {
            // 1. History Data
            const histRes = await fetch(`${API_BASE}/dashboard/history/${CABLE_ID}`);
            const history = await histRes.json();
            if (!history.length) return;

            const sorted = history.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const latest = sorted[sorted.length - 1];

            // 2. Carbon Data (NEW)
            const carbonRes = await fetch(`${API_BASE}/dashboard/carbon/${CABLE_ID}`);
            const carbon = await carbonRes.json();

            // Render Operational
            document.getElementById('health-val').innerText = Math.round(latest.health) + '%';
            let rulDisplay = Math.round(latest.rulInDays || 0);
            if (latest.health <= 0) rulDisplay = 0;
            document.getElementById('rul-val').innerText = rulDisplay;

            // Render Carbon (NEW)
            if (carbon) {
                document.getElementById('esg-avoided').innerText = carbon.avoidedCarbonKg.toFixed(2);
                document.getElementById('esg-embedded').innerText = carbon.embeddedCarbonKg.toFixed(2) + ' kg';
            }

            // Chart & Alert Logic
            let color = latest.health > 70 ? '#33cc33' : (latest.health > 50 ? '#ffcc00' : '#ff3333');
            document.getElementById('health-val').style.color = color;
            healthChartInstance.data.labels = sorted.map(h => h.timestamp);
            healthChartInstance.data.datasets[0].data = sorted.map(h => h.health);
            healthChartInstance.data.datasets[0].borderColor = color;
            healthChartInstance.update();

            updateAlertBox(latest.health);

        } catch (e) { console.warn("Polling...", e); }
    }

    function updateAlertBox(health) {
        const box = document.getElementById('alert-container');
        const title = document.getElementById('alert-title');
        const details = document.getElementById('alert-details');
        const save = document.getElementById('alert-savings');

        if (health < 50) {
            box.classList.add('critical-active');
            title.innerHTML = `⚠️ CRITICAL ALERT: CABLE-${CABLE_ID}`;
            details.innerHTML = "Action Required: IMMEDIATE replacement.<br>Risk: Assembly Line Outage.";
            save.style.display = 'block';
            save.innerText = "Potential Savings: $12,000";
        } else {
            box.classList.remove('critical-active');
            title.innerText = "NO ACTIVE ALERTS";
            details.innerText = "System operating within normal parameters.";
            save.style.display = 'none';
        }
    }
</script>
</body>
</html>